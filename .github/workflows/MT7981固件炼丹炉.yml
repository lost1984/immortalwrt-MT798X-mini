name: "MT7981å›ºä»¶ç‚¼ä¸¹ç‚‰ï¼šä¸€é”®æˆç –å¤§å¸ˆ"

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'é€‰æ‹© OpenWrt ç‰ˆæœ¬'
        required: true
        type: choice
        options:
          - 23.05
          - 24.10
        default: '24.10'
      device:
        description: 'é€‰æ‹©è¦ç¼–è¯‘çš„æœºå‹'
        required: true
        type: choice
        options:
          - abt_asr3000
          - cetron_ct3003
          - cmcc_a10
          - cmcc_rax3000m-emmc
          - cmcc_rax3000m
          - cmcc_rax3000m-emmc-usboffload
          - cmcc_rax3000m-usboffload
          - h3c_nx30pro
          - huasifei_wh3000-emmc
          - imou_lc-hx3001
          - jcg_q30
          - konka_komi-a31
          - livinet_zr-3020
          - mt7981-360-t7-108M
          - mt7981-clt-r30b1
          - mt7981-clt-r30b1-112M
          - xiaomi_mi-router-ax3000t
          - xiaomi_mi-router-ax3000t-stock
          - xiaomi_mi-router-wr30u-112m
          - xiaomi_mi-router-wr30u-stock

permissions:
  contents: write  # åŒ…å« releases çš„å†™æƒé™

env:
  REPO_URL: ${{ github.event.inputs.version == '23.05' && 'https://github.com/padavanonly/immortalwrt-mt798x-23.05' || 'https://github.com/padavanonly/immortalwrt-mt798x-24.10' }}
  REPO_BRANCH: ${{ github.event.inputs.version == '23.05' && 'openwrt-23.05' || '2410' }}
  BASE_CONFIG_FILE: ${{ github.event.inputs.version == '23.05' && 'rax3Km-2305.config' || 'rax3Km-2410.config' }}
  DIY_P1_SH: scripts/diy-part1.sh
  DIY_P2_SH: scripts/diy-part2.sh
  UPLOAD_FIRMWARE: true
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: åˆå§‹åŒ–ç¯å¢ƒ
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache/CodeQL
        sudo docker image prune --all --force
        sudo -E apt-get -qq update
        sudo -E apt-get -qq install -y ack antlr3 asciidoc autoconf automake autopoint binutils bison build-essential \
          bzip2 ccache cmake cpio curl device-tree-compiler fastjar flex gawk gettext gcc-multilib g++-multilib \
          git gperf haveged help2man intltool libc6-dev-i386 libelf-dev libfuse-dev libglib2.0-dev libgmp3-dev \
          libltdl-dev libmpc-dev libmpfr-dev libncurses5-dev libncursesw5-dev libpython3-dev libreadline-dev \
          libssl-dev libtool lrzsz mkisofs msmtp ninja-build p7zip p7zip-full patch pkgconf python2.7 python3 \
          python3-pyelftools python3-setuptools qemu-utils rsync scons squashfs-tools subversion swig texinfo \
          uglifyjs upx-ucl unzip vim wget xmlto xxd zlib1g-dev
        sudo -E apt-get -qq autoremove --purge
        sudo -E apt-get -qq clean
        sudo timedatectl set-timezone "$TZ"
        sudo mkdir -p /workdir
        sudo chown $USER:$GROUPS /workdir

    - name: å…‹éš†æºç 
      working-directory: /workdir
      run: |
        df -hT $PWD
        git clone $REPO_URL -b $REPO_BRANCH openwrt
        ln -sf /workdir/openwrt $GITHUB_WORKSPACE/openwrt

    - name: è°ƒè¯•ï¼šæ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
      run: |
        ls -la $GITHUB_WORKSPACE/scripts/

    - name: åŠ è½½è‡ªå®šä¹‰ Feeds
      run: |
        cd openwrt
        chmod +x $GITHUB_WORKSPACE/$DIY_P1_SH
        $GITHUB_WORKSPACE/$DIY_P1_SH

    - name: æ›´æ–° Feeds
      run: |
        cd openwrt
        ./scripts/feeds update -a

    - name: å®‰è£… Feeds
      run: |
        cd openwrt
        ./scripts/feeds install -a

    - name: è½¬æ¢æœºå‹åç§°å¹¶åŠ è½½é…ç½®
      run: |
        # æ ¹æ®ç‰ˆæœ¬è½¬æ¢æœºå‹åç§°ï¼ˆä»…å¯¹ 23.05 è¿›è¡Œè½¬æ¢ï¼‰
        if [ "${{ github.event.inputs.version }}" == "23.05" ]; then
          case "${{ github.event.inputs.device }}" in
            "cmcc_rax3000m-usboffload")
              DEVICE="cmcc_rax3000m"
              echo "è½¬æ¢æœºå‹ï¼šcmcc_rax3000m-usboffload -> cmcc_rax3000m (23.05)"
              ;;
            "cmcc_rax3000m-emmc-usboffload")
              DEVICE="cmcc_rax3000m-emmc"
              echo "è½¬æ¢æœºå‹ï¼šcmcc_rax3000m-emmc-usboffload -> cmcc_rax3000m-emmc (23.05)"
              ;;
            "huasifei_wh3000-emmc")
              echo "é”™è¯¯ï¼šhuasifei_wh3000-emmc åœ¨ 23.05 ä¸­ä¸æ”¯æŒ"
              exit 1
              ;;
            *)
              DEVICE="${{ github.event.inputs.device }}"
              ;;
          esac
        else
          # 24.10 ä¸è¿›è¡Œè½¬æ¢ï¼Œç›´æ¥ä½¿ç”¨ç”¨æˆ·é€‰æ‹©çš„æœºå‹
          DEVICE="${{ github.event.inputs.device }}"
          if [ "$DEVICE" == "huasifei_wh3000-emmc" ]; then
            echo "è­¦å‘Šï¼šhuasifei_wh3000-emmc æ˜¯ 24.10 çš„æ–°å® ï¼Œäº«å—å§ï¼"
          fi
        fi
        # è®¾ç½®ç¯å¢ƒå˜é‡ä¾›åç»­æ­¥éª¤ä½¿ç”¨
        echo "DEVICE=$DEVICE" >> $GITHUB_ENV
        # åŠ è½½è‡ªå®šä¹‰é…ç½®å¹¶è®¾ç½®ç›®æ ‡è®¾å¤‡
        [ -e files ] && mv files openwrt/files
        [ -e $BASE_CONFIG_FILE ] && cp $BASE_CONFIG_FILE openwrt/.config
        cd openwrt
        sed -i "/CONFIG_TARGET_DEVICE_mediatek_mt7981_DEVICE_/d" .config
        echo "CONFIG_TARGET_DEVICE_mediatek_mt7981_DEVICE_$DEVICE=y" >> .config
        echo "CONFIG_TARGET_DEVICE_PACKAGES_mediatek_mt7981_DEVICE_$DEVICE=\"\"" >> .config
        make defconfig

    - name: æ£€æŸ¥é…ç½®
      id: check_config
      run: |
        cd openwrt
        if grep -q "CONFIG_TARGET_DEVICE_mediatek_mt7981_DEVICE_${{ env.DEVICE }}=y" .config; then
          echo "é…ç½®æ£€æŸ¥é€šè¿‡ï¼šç›®æ ‡è®¾å¤‡ ${{ env.DEVICE }} å·²æ­£ç¡®é…ç½®"
          echo "config_status=success" >> $GITHUB_OUTPUT
        else
          echo "é”™è¯¯ï¼šé…ç½®æ£€æŸ¥å¤±è´¥ï¼Œæœªæ‰¾åˆ°ç›®æ ‡è®¾å¤‡ ${{ env.DEVICE }} çš„é…ç½®"
          exit 1
        fi

    - name: æ‰§è¡Œè‡ªå®šä¹‰è„šæœ¬
      if: steps.check_config.outputs.config_status == 'success'
      run: |
        cd openwrt
        chmod +x $GITHUB_WORKSPACE/$DIY_P2_SH
        $GITHUB_WORKSPACE/$DIY_P2_SH

    - name: ä¸‹è½½è½¯ä»¶åŒ…
      if: steps.check_config.outputs.config_status == 'success'
      run: |
        cd openwrt
        make download -j8
        find dl -size -1024c -exec ls -l {} \;
        find dl -size -1024c -exec rm -f {} \;

    - name: ç¼–è¯‘å›ºä»¶
      id: compile
      if: steps.check_config.outputs.config_status == 'success'
      run: |
        cd openwrt
        echo -e "$(nproc) thread compile for ${{ env.DEVICE }}"
        make -j$(nproc) V=s || make -j1 V=s
        echo "status=success" >> $GITHUB_OUTPUT
        echo "FILE_DATE=_$(date +"%Y%m%d%H%M")" >> $GITHUB_ENV

    - name: æ£€æŸ¥ç£ç›˜ç©ºé—´ä½¿ç”¨æƒ…å†µ
      if: steps.check_config.outputs.config_status == 'success' && !cancelled()
      run: df -hT

    - name: æ•´ç†æ–‡ä»¶
      id: organize
      if: steps.check_config.outputs.config_status == 'success' && env.UPLOAD_FIRMWARE == 'true' && !cancelled()
      run: |
        cd openwrt/bin/targets/*/*
        rm -rf packages
        echo "FIRMWARE=$PWD" >> $GITHUB_ENV
        echo "status=success" >> $GITHUB_OUTPUT

    - name: ä¸Šä¼ å›ºä»¶ç›®å½•
      uses: actions/upload-artifact@v4
      if: steps.check_config.outputs.config_status == 'success' && steps.organize.outputs.status == 'success' && !cancelled()
      with:
        name: OpenWrt_firmware_${{ github.event.inputs.version }}_${{ env.DEVICE }}${{ env.FILE_DATE }}
        path: ${{ env.FIRMWARE }}

    - name: å‘å¸ƒå›ºä»¶ï¼šç –å‚å¤§å¸ˆçš„æœ€æ–°æ°ä½œ
      if: steps.check_config.outputs.config_status == 'success' && steps.organize.outputs.status == 'success' && !cancelled()
      uses: softprops/action-gh-release@v1
      with:
        tag_name: "v${{ github.event.inputs.version }}_${{ env.DEVICE }}_${{ env.FILE_DATE }}"
        name: "MT7981 å›ºä»¶ ${{ github.event.inputs.version }} - ${{ env.DEVICE }}"
        body: |
          ğŸ‰ **ç –å‚å¤§å¸ˆæœ€æ–°åŠ›ä½œå‘å¸ƒå•¦ï¼** ğŸ‰  
          ç»è¿‡æ— æ•°æ¬¡â€œçƒ§ç –â€å®éªŒï¼Œè¿™æ¬¾å›ºä»¶ç»ˆäºå‡ºç‚‰ï¼  
          - **ç‰ˆæœ¬**: ${{ github.event.inputs.version }}  
          - **æœºå‹**: ${{ env.DEVICE }}  
          - **ç‰¹åˆ«è¯´æ˜**: å¦‚æœä½ çš„è·¯ç”±å™¨å˜ç –äº†ï¼Œåˆ«æ€ªæˆ‘ï¼Œå¯èƒ½æ˜¯å®ƒè‡ªå·±æƒ³é€€ä¼‘äº†ï¼  
          - **ä½¿ç”¨å»ºè®®**: åˆ·ä¹‹å‰è¯·å¤‡ä»½ï¼Œåˆ·ä¹‹åè¯·ç¥ˆç¥·ï¼Œåˆ·å®Œå˜ç –è¯·ç‚¹ä¸ª Starå®‰æ…°æˆ‘ï¼  
          å¿«æ¥ä¸‹è½½ä½“éªŒå§ï¼ŒMT7981 çš„â€œé­”æ³•â€åœ¨å¬å”¤ä½ ï¼  
        files: |
          ${{ env.FIRMWARE }}/*.bin
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
